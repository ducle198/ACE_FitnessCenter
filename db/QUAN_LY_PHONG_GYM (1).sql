CREATE DATABASE ACE_FitnessCenter2
GO
/*
USE ACE_FitnessCenter2
GO */
IF OBJECT_ID('NHANVIEN') IS NOT NULL
DROP TABLE NHANVIEN
GO

IF OBJECT_ID('KHACHHANG') IS NOT NULL
DROP TABLE KHACHHANG
GO
IF OBJECT_ID('NHANVIEN') IS NOT NULL
DROP TABLE NHANVIEN
GO
IF OBJECT_ID('HOIVIEN') IS NOT NULL
DROP TABLE HOIVIEN
GO
IF OBJECT_ID('THEODOI') IS NOT NULL
DROP TABLE THEODOI
GO
IF OBJECT_ID('DICHVU') IS NOT NULL
DROP TABLE DICHVU
GO
IF OBJECT_ID('CATAP') IS NOT NULL
DROP TABLE CATAP
GO
IF OBJECT_ID('HOADON') IS NOT NULL
DROP TABLE HOADON
GO
IF OBJECT_ID('CTHOADON') IS NOT NULL
DROP TABLE CTHOADON
GO

CREATE TABLE KHACHHANG(
	MAKH VARCHAR(20) NOT NULL,
	TENKH NVARCHAR(50) NOT NULL,
	GIOITINH BIT  NOT NULL DEFAULT 0,  ---0 là nữ, 1 là nam
	IDCARD VARCHAR(15) NOT NULL,
	NGAYSINH  DATE NOT NULL,
	DIACHI NVARCHAR(100) NOT NULL,
	SDT VARCHAR(15) NOT NULL,
	EMAIL VARCHAR(50) NOT NULL,
	HINHANH VARCHAR(MAX) NULL,
	GHICHU NVARCHAR(MAX) NULL,
	PRIMARY KEY(MAKH)
)
INSERT INTO KHACHHANG VALUES('KH1', N'Nguyễn Thái Chung', 1, '026099003717', '9/8/1999', N'Vĩnh Phúc','0984998602','chungntph13390@fpt.edu.vn','', N'Thừa cân')
INSERT INTO KHACHHANG VALUES('KH2', N'Lý Minh Tuấn', 1, '026099003818', '10/8/1995', N'Hà Nội','0984998752','lyminh@fpt.edu.vn','', N'Thừa cân')
INSERT INTO KHACHHANG VALUES('KH3', N'Đinh Thị Kim Cúc', 0, '026099003919', '5/6/1999', N'Nghệ an','0984998123','ducmm@fpt.edu.vn','', N'Tăng cân')
GO





CREATE TABLE NHANVIEN(
	MANV VARCHAR(20) NOT NULL,
	MATKHAU VARCHAR(50) NOT NULL,
	TENNV NVARCHAR(50) NOT NULL,
	GIOITINH BIT  NOT NULL DEFAULT 0,  ---0 là nữ, 1 là nam
	IDCARD VARCHAR(15) NOT NULL,
	NGAYSINH  DATE NOT NULL,
	DIACHI NVARCHAR(100) NOT NULL,
	SDT VARCHAR(15) NOT NULL,
	EMAIL VARCHAR(50) NOT NULL,
	CHUCVU NVARCHAR(50) NOT NULL,
	KINHNGHIEM FLOAT NOT NULL,
	HINHANH VARCHAR(100) NULL,
	TRANGTHAI BIT  NOT NULL DEFAULT 0,  ---0 là ĐANG NGHỈ, 1 ĐANG HOẠT ĐỘNG
	PRIMARY KEY(MANV)
)
INSERT INTO NHANVIEN VALUES('NV1','123', N'Nguyễn Thái Chung', 1, '026099222717', '9/8/1999', N'Vĩnh Phúc','0984998602','chungntph13390@fpt.edu.vn', N'PT',5,'', 1)
INSERT INTO NHANVIEN VALUES('NV2','123', N'Nguyễn Văn Giang', 1, '02609555717', '9/8/2002', N'Vĩnh Phúc','0984963212','giangph13390@fpt.edu.vn', N'PT',5,'', 1)
INSERT INTO NHANVIEN VALUES('NV3','123', N'Lê Văn Đức', 1, '026099666717', '9/8/1995', N'Hà Nội','0984996202','ducph13390@fpt.edu.vn', N'Marketing',3,'', 1)
INSERT INTO NHANVIEN VALUES('QL1','123', N'Lý Minh Tuấn', 1, '026099666717', '9/8/1995', N'Hà Nội','0984996202','ducph13390@fpt.edu.vn', N'Quản lý',3,'', 1)
INSERT INTO NHANVIEN VALUES('QL2','123', N'Lò A Thi', 1, '026099666717', '9/8/1995', N'Hà Nội','0984996202','ducph13390@fpt.edu.vn', N'Quản lý',3,'', 1)
INSERT INTO NHANVIEN VALUES('NV4','123', N'Nguyễn Đình Thi', 1, '026099666717', '9/8/1995', N'Hà Nội','0984996202','ducph13390@fpt.edu.vn', N'Marketing',3,'', 1)
GO
CREATE  TABLE CATAP(
MACA VARCHAR(20) NOT NULL,
TENCA NVARCHAR(50) NOT NULL,
GIOBD varchar(10) NOT NULL,
GIOKT VARCHAR(10) NOT NULL,
PRIMARY KEY(MACA)
)
INSERT INTO CATAP VALUES('W01', 'Ca 1', '07:00:00','09:00:00')
INSERT INTO CATAP VALUES('W02', 'Ca 2', '10:00:00','12:00:00')
INSERT INTO CATAP VALUES('W03', 'Ca 3', '14:00:00','16:00:00')
INSERT INTO CATAP VALUES('W04', 'Ca 4', '16:00:00','18:00:00')
INSERT INTO CATAP VALUES('W05', 'Ca 5', '18:00:00','20:00:00')
INSERT INTO CATAP VALUES('W06', 'Ca 6', '20:00:00','22:00:00')
GO
CREATE TABLE DICHVU(
	MADV VARCHAR(20) NOT NULL,
	TENDV NVARCHAR(50) NOT NULL,
	GIADV FLOAT NOT NULL,
	MACA VARCHAR(20) NOT NULL,
	HANSUDUNG Nvarchar(20) NOT NULL,
	TRANGTHAI BIT  NOT NULL DEFAULT 0,  ---0 là ĐANG NGHỈ, 1 ĐANG HOẠT ĐỘNG
	MOTA NVARCHAR(MAX) NULL,
	FOREIGN KEY (MACA) REFERENCES CATAP(MACA) ON UPDATE CASCADE,
	PRIMARY KEY(MADV)
)
select * from DICHVU
INSERT INTO DICHVU VALUES('GYM1', N'GYM cơ bản', 500000, 'W01', N'30 NGAY',1,N'Tập PT hướng dẫn 2 buổi đầu')
INSERT INTO DICHVU VALUES('GYM2', N'GYM nâng cao', 500000, 'W02', N'365 NGAY',1,N'Tập full option')
INSERT INTO DICHVU VALUES('D1', N'Dancer cơ bản', 600000, 'W03', N'60 NGAY',1,N'Có giáo viên hướng dẫn')
INSERT INTO DICHVU VALUES('D2', N'Gym Cơ Bụng', 600000, 'W03', N'60 NGAY',1,N'Có giáo viên hướng dẫn')
INSERT INTO DICHVU VALUES('D3', N'Gym Cơ Mông', 600000, 'W03', N'60 NGAY',1,N'Có giáo viên hướng dẫn')
INSERT INTO DICHVU VALUES('D4', N'Gym Cơ Ngực', 600000, 'W03', N'60 NGAY',1,N'Có giáo viên hướng dẫn')
INSERT INTO DICHVU VALUES('D5', N'Gym Toàn Thân', 600000, 'W03', N'120 NGAY',1,N'Có giáo viên hướng dẫn')
INSERT INTO DICHVU VALUES('D6', N'Chạy 2h', 600000, 'W03', N'30 NGAY',1,N'Có giáo viên hướng dẫn')
INSERT INTO DICHVU VALUES('DA1', N'Đồ Ăn Tăng Cơ', 300000,'W03', N'30 NGAY',1,N'Có Nhân Viên hướng dẫn')
INSERT INTO DICHVU VALUES('DA2', N'Đồ uống Tăng cơ', 200000,'W03', N'30 NGAY',2,N'Có Nhân Viên hướng dẫn')
INSERT INTO DICHVU VALUES('DA3', N'Sữa Tăng Cơ', 500000, 'W01', N'30 NGAY',2,N'Có Nhân Viên hướng dẫn')
INSERT INTO DICHVU VALUES('DA4', N'Thực Phẩm Chức Năng', 1000000,'W03' ,N'30 NGAY',1,N'Có Nhân Viên hướng dẫn')
INSERT INTO DICHVU VALUES('DA5', N'Sữa tươi', 10000, 'W01', N'30 NGAY',2,N'Có Nhân Viên hướng dẫn')
GO

CREATE TABLE HOIVIEN(
    
	MAHV INT IDENTITY(1,1) NOT NULL,
	MADV VARCHAR(20) NOT NULL,
	MAKH VARCHAR(20) NOT NULL,
	NgayBatDauVao date NOT NULL,	
	TRANGTHAI BIT  NOT NULL DEFAULT 0,  ---0 là ĐANG NGHỈ, 1 ĐANG HOẠT ĐỘNG	
	PRIMARY KEY (MAHV),
	FOREIGN KEY (MADV) REFERENCES DICHVU(MADV) ON DELETE NO ACTION ON UPDATE CASCADE,
	FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH) ON DELETE CASCADE
)
INSERT INTO HOIVIEN VALUES('D1','KH1',GETDATE(),0)
INSERT INTO HOIVIEN VALUES('D2','KH2',GETDATE(),1)
INSERT INTO HOIVIEN VALUES('D3','KH3',GETDATE(),0)


/*
INSERT INTO HOIVIEN VALUES('HV01','GYM2','KH1','01/08/2021',1,'')
INSERT INTO HOIVIEN VALUES('HV02','D4','KH2','02/11/2021',1,'')
INSERT INTO HOIVIEN VALUES('HV03','D6','KH3','03/11/2021',1,'')
GO
*/
create table TheoDoi(
    IDtheodoi Varchar(10),
	MAHV INT NOT NULL,
	CANNANG FLOAT DEFAULT 1,
	SODOV1 FLOAT DEFAULT -1,
	SODOV2 FLOAT DEFAULT -1,
	SODOV3 FLOAT DEFAULT -1,
	NgayTheoDoi DATETIME DEFAULT GETDATE(),
	GHICHU NVARCHAR(MAX) NULL,
	PRIMARY KEY (IDTheodoi),
	FOREIGN KEY (MaHV) REFERENCES HoiVien(MaHV)  ON DELETE CASCADE
)
GO
INSERT INTO TheoDoi VALUES( 'Tuan1HV1',1,70, 90,90,86,'11/28/2021',N'Thừa Mỡ,Cần Giảm Mỡ Eo')
INSERT INTO TheoDoi VALUES( 'Tuan2HV1',1,71, 93,80,89,'11/29/2021',N'Đã giảm bớt Mỡ eo,cần Tăng Thêm Cơ Ngực,Mông')
INSERT INTO TheoDoi VALUES( 'Tuan3HV1',1,75, 99,78,88,'11/29/2021',N'Đã giảm bớt Mỡ eo,cần Tăng Thêm Cơ Ngực,Mông')
INSERT INTO TheoDoi VALUES( 'Tuan4HV1',1,78, 102,73,89,'11/29/2021',N'Đã Tăng Thêm Cơ Ngực,Mông Thân Hình Đẹp')
INSERT INTO TheoDoi VALUES( 'Tuan1HV2', 2,80, 90,90,80,'11/01/2021',N'Bình Thường')
INSERT INTO TheoDoi VALUES( 'Tuan1HV3',3,65,90,90,80,'11/02/2021',N'Bình Thường')
GO
CREATE TABLE HOADON(
	MAHD VARCHAR(20) NOT NULL,
	NGAYLAP DATE DEFAULT getdate(),
	MAKH VARCHAR(20)  NULL,
	MANV VARCHAR(20)  NULL,
	TONGTIEN FLOAT  NULL,
	GIAMGIA FLOAT  NULL,
	CONGNO FLOAT  NULL,
	KHACHDATRA FLOAT NOT NULL
	PRIMARY KEY (MAHD),
	FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH) ON DELETE CASCADE ,
	FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV) ON DELETE NO ACTION ON UPDATE CASCADE
)

INSERT INTO HOADON VALUES('HD1','11/25/2021','KH1','NV1', 100000, 50, 400000,100000)
INSERT INTO HOADON VALUES('HD2','11/26/2021','KH2','NV2', 100000, 50, 400000,100000)
INSERT INTO HOADON VALUES('HD3','11/27/2021','KH3','NV3', 100000, 50, 400000,100000)

GO
CREATE TABLE CTHOADON (
	MACTHD INT IDENTITY(1,1),
	MAHD VARCHAR(20) NOT NULL,
	MADV VARCHAR(20) NOT NULL,
	SOLUONG INT NOT NULL,
	DONGIA FLOAT NOT NULL,
	GIAMGIA FLOAT NULL,
	THANHTIEN FLOAT NOT NULL,
	GHICHU NVARCHAR(50) NULL,
	PRIMARY KEY (MACTHD),
	FOREIGN KEY (MAHD) REFERENCES HOADON(MAHD)  ON UPDATE CASCADE ON DELETE CASCADE,
	FOREIGN KEY (MADV) REFERENCES DICHVU(MADV) ON DELETE NO ACTION ON UPDATE CASCADE
)
INSERT INTO CTHOADON VALUES('HD1','GYM1', 1, 500000, 50, 250000, N'Khách hàng vip')
INSERT INTO CTHOADON VALUES('HD1','D1', 1, 600000, 50, 350000, N'Khách hàng vip')
INSERT INTO CTHOADON VALUES('HD2','D1', 1, 600000, 50, 350000, N'Khách hàng vip')





SELECT *FROM CTHOADON
DELETE FROM CTHOADON
DELETE FROM DICHVU
DELETE FROM CATAP
DELETE FROM NHANVIEN
DELETE FROM KHACHHANG
DELETE FROM HOIVIEN
DELETE FROM HOADON
DELETE FROM TheoDoi
SELECT *FROM HOADON


SELECT MAKH FROM HOIVIEN WHERE MADV LIKE 'D1' AN
SELECT *FROM KHACHHANG WHERE MAKH NOT IN(SELECT MAKH FROM HOIVIEN WHERE MADV LIKE 'D1')
SELECT HOADON.MAKH FROM HOADON INNER JOIN CTHOADON ON   HOADON.MAHD = CTHOADON.MAHD
WHERE CTHOADON.MADV LIKE 'D1'

 SELECT *FROM TheoDoi
 select *from CTHOADON join DICHVU on CTHOADON.MADV=DICHVU.MADV join HOADON on CTHOADON.MAHD=HOADON.MAHD

 select TENDV,sum(SOLUONG) as N'Số Lượng Đã Bán',sum(THANHTIEN) as N'Thành Tiền' from CTHOADON join DICHVU on CTHOADON.MADV=DICHVU.MADV join HOADON on CTHOADON.MAHD=HOADON.MAHD
 where year(NGAYLAP)=year(getdate())
 group by TENDV

 select sum(THANHTIEN)from CTHOADON join HOADON on CTHOADON.MAHD=HOADON.MAHD where  year(NGAYLAP)=year(getdate())



 select sum(h.TongGia)as N'Tổng Tiền1' from HoaDon d join HoaDonChiTiet h \n



 select TENDV,sum(SOLUONG) as N'Số Lượng Đã Bán' from  CTHOADON join DICHVU on CTHOADON.MADV=DICHVU.MADV  join HOADON on CTHOADON.MAHD=HOADON.MAHD
 where  year(NGAYLAP)=year(getdate())
 group by TENDV